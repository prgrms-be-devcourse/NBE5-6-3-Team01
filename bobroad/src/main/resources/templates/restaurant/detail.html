<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
  <meta charset="UTF-8">
  <title>ì‹ë‹¹ ìƒì„¸</title>
  <link rel="stylesheet" href="/css/restaurant/detail.css">


</head>
<body>
<main layout:fragment="content">
  <div style="display: flex; height: 100%;">
    <div id="dtl" class="restaurant-wrapper">
      <div class="restaurant-info"> <!-- ì™¼ìª½ ìƒì„¸ ì •ë³´ -->
        <!-- ì‹ë‹¹ ì´ë¦„ -->
        <div class="main-main">
          <span class="main-title" th:text="${restaurant.name}">ì‹ë‹¹ëª…</span>
          <span class="main-branch" th:text="${restaurant.branch}">ì§€ì ëª…</span>
          <span class="category-list" th:text="${restaurant.category}">ì¹´í…Œê³ ë¦¬</span>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="action-buttons">
          <div class="action-item" style="border-right: 1px solid #eee;">
            <img src="/img/location.png" alt="ìœ„ì¹˜ ë³´ê¸°" class="action-icon">
            <span style="margin-top: 5px;">ìœ„ì¹˜ ë³´ê¸°</span>
          </div>
          <div class="action-item" style="border-right: 1px solid #eee;">
            <button type="button"
                    class="bookmark-btn focus:outline-none"
                    th:attr="data-id=${restaurant.id}">
              <svg xmlns="http://www.w3.org/2000/svg"
                   class="h-6 w-6 text-gray-400 hover:text-gray-600 fill-current"
                   viewBox="0 0 20 20" fill="currentColor">
                <path d="M5 3a2 2 0 00-2 2v14l7-5 7 5V5a2 2 0 00-2-2H5z"/>
              </svg>
            </button>
            <span style="margin-top: 5px;">ë¶ë§ˆí¬</span>
          </div>
          <div class="action-item share-btn" style="cursor: pointer;">
            <img src="/img/share.png" alt="ê³µìœ í•˜ê¸°" class="action-icon">
            <span style="margin-top: 5px;">ê³µìœ í•˜ê¸°</span>
          </div>
        </div>

        <!-- ì •ë³´ ì„¹ì…˜ -->
        <div class="info-section">
          <p th:if="${!#strings.isEmpty(restaurant.address)}">
            <strong>ì£¼ì†Œ</strong> <span th:text="${restaurant.address}">ì£¼ì†Œ</span>
          </p>
          <p th:if="${restaurant.detail != null and !#strings.isEmpty(restaurant.detail.tel)}">
            <strong>ì—°ë½ì²˜</strong> <span th:text="${restaurant.detail.tel}">ì—°ë½ì²˜</span>
          </p>
          <p th:if="${restaurant.detail != null and !#strings.isEmpty(restaurant.detail.homePageURL)}">
            <strong>í™ˆí˜ì´ì§€</strong>
            <a th:href="@{${restaurant.detail.homePageURL}}"
               th:text="${restaurant.detail.homePageURL}"
               class="homepage-url"
               target="_blank"
               rel="noopener noreferrer">
            </a>
          </p>

          <p th:if="${restaurant.detail != null and !#strings.isEmpty(restaurant.detail.dayOff)}">
            <strong>íœ´ë¬´ì¼</strong> <span th:text="${restaurant.detail.dayOff}">íœ´ë¬´ì¼</span>
          </p>
          <p th:if="${restaurant.detail != null and !#strings.isEmpty(restaurant.detail.rowBusinessTime)}">
            <strong>ì˜ì—…ì‹œê°„</strong> <span th:text="${restaurant.detail.rowBusinessTime}">ì˜ì—…ì‹œê°„</span>
          </p>
        </div>

        <!-- ë©”ë‰´ -->
        <div class="detail-wrapper">
          <div class="menu-title">ë©”ë‰´</div>

          <div th:if="${topMenus != null and !topMenus.isEmpty()}" class="menu-list">
            <div th:each="menu : ${topMenus}" class="menu-card">
              <div style="width: 100%;">
                <p class="menu-name" th:text="${menu.name}">ë©”ë‰´ëª…</p>
                <p class="menu-price"
                   th:text="${#numbers.formatInteger(menu.price, 3, 'COMMA') + 'ì›'}">ê°€ê²©</p>
              </div>
            </div>
          </div>

          <div th:unless="${topMenus != null and !topMenus.isEmpty()}" class="none-menu-card">
            <div style="width: 100%;">
              <p>ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>

        <div class="detail-wrapper">
          <div class="menu-title">ì‹œì„¤ ì•ˆë‚´</div>
          <p>
            <strong>ë°°ë‹¬</strong>
            <span th:if="${restaurant.detail.delivery}"> â˜ºï¸ê°€ëŠ¥í•´ìš”</span>
            <span th:unless="${restaurant.detail.delivery}"> ğŸ˜¢ì–´ë ¤ì›Œìš”</span>
          </p>
          <p>
            <strong>ì£¼ì°¨</strong>
            <span th:if="${restaurant.detail.parking}"> â˜ºï¸ê°€ëŠ¥í•´ìš”</span>
            <span th:unless="${restaurant.detail.parking}"> ğŸ˜¢ì–´ë ¤ì›Œìš”</span>
          </p>
          <p>
            <strong>ì™€ì´íŒŒì´</strong>
            <span th:if="${restaurant.detail.wifi}"> â˜ºï¸ì œê³µí•´ìš”</span>
            <span th:unless="${restaurant.detail.wifi}"> ğŸ˜¢ì œê³µí•˜ì§€ ì•Šì•„ìš”</span>
          </p>
        </div>

      </div>
    </div>

    <!-- ì§€ë„ -->
    <div id="map" style="width: 100%;"></div>
  </div>

  <script th:src="@{('https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoMapApiKey} + '&libraries=services')}"></script>
  <script th:inline="javascript">
    var lat = [[${restaurant.latitude}]];
    var lng = [[${restaurant.longitude}]];

    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
        mapOption = {
          center: new kakao.maps.LatLng(lat, lng), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
          level: 1 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };

    // ì§€ë„ë¥¼ í‘œì‹œí•  divì™€  ì§€ë„ ì˜µì…˜ìœ¼ë¡œ  ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤
    var markerPosition = new kakao.maps.LatLng(lat, lng);

    // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var marker = new kakao.maps.Marker({
      position: markerPosition
    });

    // ë§ˆì»¤ê°€ ì§€ë„ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
    marker.setMap(map);
  </script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const userId = /*[[${userId}]]*/ 0;

      function setGreen(btn) {
        const svg = btn.querySelector('svg');
        svg.classList.replace('text-gray-400', 'text-green-400');
        svg.classList.replace('hover:text-gray-600', 'hover:text-green-600');
      }

      function setGray(btn) {
        const svg = btn.querySelector('svg');
        svg.classList.replace('text-green-400', 'text-gray-400');
        svg.classList.replace('hover:text-green-600', 'hover:text-gray-600');
      }

      if (userId > 0) {
        fetch(`/api/bookmarks/member/${userId}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(res.status);
          }
          return res.json();
        })
        .then(json => {
          const list = Array.isArray(json.data) ? json.data : [];
          const set = new Set(list.map(d => d.restaurantId));
          document.querySelectorAll('.bookmark-btn').forEach(btn => {
            const rid = Number(btn.dataset.id);
            if (set.has(rid)) {
              setGreen(btn);
            }
          });
        })
        .catch(err => console.error('ì´ˆê¸° ë¶ë§ˆí¬ ì˜¤ë¥˜:', err));
      }

      document.querySelectorAll('.ranking-card').forEach(card => {
        card.addEventListener('click', () => {
          window.location.href = card.dataset.link;
        });
      });

      document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          if (userId <= 0) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
            return window.location.href = '/user/signin';
          }

          const rid = btn.dataset.id;
          fetch(`/api/bookmarks/toggle/${rid}`, {method: 'POST'})
          .then(res => {
            if (!res.ok) {
              throw new Error(res.status);
            }
            return res.json();
          })
          .then(data => {
            if (data.added) {
              setGreen(btn);
              alert('ë¶ë§ˆí¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              setGray(btn);
              alert('ë¶ë§ˆí¬ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(err => console.error('í† ê¸€ ì˜¤ë¥˜:', err));
        });
      });
    });
  </script>

  <script>
    document.querySelector('.share-btn')?.addEventListener('click', () => {
      const url = window.location.href;

      navigator.clipboard.writeText(url)
      .then(() => {
        alert('í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      })
      .catch(err => {
        console.error('URL ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('URL ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ğŸ˜¢');
      });
    });

  </script>

  <script th:inline="javascript">
    document.querySelector('.recenter-btn')?.addEventListener('click', () => {
      const centerPosition = new kakao.maps.LatLng([[${restaurant.latitude}]],
          [[${restaurant.longitude}]]);
      map.setCenter(centerPosition);
      map.setLevel(1);
    });
  </script>

</main>
</body>
</html>
