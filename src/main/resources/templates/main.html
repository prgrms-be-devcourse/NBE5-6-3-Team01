<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="utf-8">
  <title>π λ°¥λ΅λ“</title>
</head>
<body>
<main layout:fragment="content">
<!-- μ§€λ„λ¥Ό ν‘μ‹ν•  div μ…λ‹λ‹¤ -->

  <div id="map-wrapper" style="position: relative; width: 100%; height: 100%;">

<div id="map" style="width:100%;height:100%;"></div>
    <div style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background: white; padding: 6px 12px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 10;">
      π½οΈ λ‚΄ μ£Όλ³€ λ§›μ§‘μ„ μ°Ύκ³  μμ–΄μ”!
    </div>

  </div>
  <script th:src="@{('https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoMapApiKey})}"></script>
<script>
  var mapContainer = document.getElementById('map'), // μ§€λ„λ¥Ό ν‘μ‹ν•  div
          mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // μ§€λ„μ μ¤‘μ‹¬μΆν‘
            level: 2 // μ§€λ„μ ν™•λ€ λ λ²¨
          };

  // μ§€λ„λ¥Ό ν‘μ‹ν•  divμ™€  μ§€λ„ μµμ…μΌλ΅  μ§€λ„λ¥Ό μƒμ„±ν•©λ‹λ‹¤
  var map = new kakao.maps.Map(mapContainer, mapOption);


  // HTML5μ geolocationμΌλ΅ μ‚¬μ©ν•  μ μλ”μ§€ ν™•μΈν•©λ‹λ‹¤
  if (navigator.geolocation) {

    // GeoLocationμ„ μ΄μ©ν•΄μ„ μ ‘μ† μ„μΉλ¥Ό μ–»μ–΄μµλ‹λ‹¤
    navigator.geolocation.getCurrentPosition(function(position) {

      var lat = position.coords.latitude, // μ„λ„
              lon = position.coords.longitude; // κ²½λ„

      var locPosition = new kakao.maps.LatLng(lat, lon), // λ§μ»¤κ°€ ν‘μ‹λ  μ„μΉλ¥Ό geolocationμΌλ΅ μ–»μ–΄μ¨ μΆν‘λ΅ μƒμ„±ν•©λ‹λ‹¤
              message = '<div style="padding:5px;">κ°€κΉμ΄ κ°•λ‚¨κµ¬μ λ§›μ§‘μ„ ν™•μΈν•΄ λ³΄μ„Έμ”!</div>'; // μΈν¬μλ„μ°μ— ν‘μ‹λ  λ‚΄μ©μ…λ‹λ‹¤

      // λ§μ»¤μ™€ μΈν¬μλ„μ°λ¥Ό ν‘μ‹ν•©λ‹λ‹¤
      displayMarker(locPosition, message);

    });

  } else { // HTML5μ GeoLocationμ„ μ‚¬μ©ν•  μ μ—†μ„λ• λ§μ»¤ ν‘μ‹ μ„μΉμ™€ μΈν¬μλ„μ° λ‚΄μ©μ„ μ„¤μ •ν•©λ‹λ‹¤

    var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
            message = 'ν„μ¬ μ„μΉμ™€ κ°€κΉμ΄ κ°•λ‚¨κµ¬μ λ§›μ§‘μ„ ν™•μΈν•΄ λ³΄μ„Έμ”!'

    displayMarker(locPosition, message);
  }

  // μ§€λ„μ— λ§μ»¤μ™€ μΈν¬μλ„μ°λ¥Ό ν‘μ‹ν•λ” ν•¨μμ…λ‹λ‹¤
  function displayMarker(locPosition, message) {

    // λ§μ»¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤
    var marker = new kakao.maps.Marker({
      map: map,
      position: locPosition
    });

    var iwContent = message, // μΈν¬μλ„μ°μ— ν‘μ‹ν•  λ‚΄μ©
            iwRemoveable = true;

    // μΈν¬μλ„μ°λ¥Ό μƒμ„±ν•©λ‹λ‹¤
    var infowindow = new kakao.maps.InfoWindow({
      content : iwContent,
      removable : iwRemoveable
    });

    // μΈν¬μλ„μ°λ¥Ό λ§μ»¤μ„μ— ν‘μ‹ν•©λ‹λ‹¤
    infowindow.open(map, marker);

    // μ§€λ„ μ¤‘μ‹¬μΆν‘λ¥Ό μ ‘μ†μ„μΉλ΅ λ³€κ²½ν•©λ‹λ‹¤
    map.setCenter(locPosition);

    // μ»¤μ¤ν…€ μ¤λ²„λ μ΄ κµ¬μ—­...
    var content = '<div class ="label">' +
            '<span class="left"></span>' +
            '<span class="center">μ»¤μ¤ν…€ μ¤λ²„λ μ΄ κµ¬μ—­...</span>' +
            '<span class="right"></span>' +
            '</div>';

// μ»¤μ¤ν…€ μ¤λ²„λ μ΄κ°€ ν‘μ‹λ  μ„μΉμ…λ‹λ‹¤
    var customOverlay = new kakao.maps.CustomOverlay({
      position: locPosition,
      content: content,
      xAnchor: 0.5,
      yAnchor: 1.1
    });

// μ»¤μ¤ν…€ μ¤λ²„λ μ΄λ¥Ό μ§€λ„μ— ν‘μ‹ν•©λ‹λ‹¤
//     customOverlay.setMap(map);
  }
</script>

    <script th:inline="javascript">
        const restaurants = /*[[${restaurants}]]*/ [];

        restaurants.forEach(r => {
            const markerPosition = new kakao.maps.LatLng(r.latitude, r.longitude);

            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;">${r.name}</div>`
            });

            kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
            kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());

            console.log('[μ „μ²΄ μ‹λ‹Ή]', restaurants);
        });
    </script>

</main>
</body>
</html>